include/master-slave.inc
[connection master]
#
# Initialize test data
connection master;
create table t1 (a int) engine=innodb;
create table t2 (a int) engine=innodb;
insert into t1 values (1);
include/save_master_gtid.inc
connection slave;
include/sync_with_master_gtid.inc
include/stop_slave.inc
set @@global.slave_parallel_threads= 3;
set @@global.slave_parallel_mode= CONSERVATIVE;
set @@global.innodb_lock_wait_timeout= 2;
set @@global.slave_transaction_retries= 0;
BEGIN;
SELECT * FROM t1 WHERE a=1 FOR UPDATE;
a
1
connection master;
SET @old_dbug= @@SESSION.debug_dbug;
SET @@SESSION.debug_dbug="+d,binlog_force_commit_id";
SET @commit_id= 10000;
update t1 set a=2 where a=1;
insert into t2 values (1);
SET @commit_id= 10001;
insert into t1 values (3);
connection slave;
include/start_slave.inc
kill T3_TID;
#
# Cleanup
connection master;
DROP TABLE t1, t2;
include/save_master_gtid.inc
connection slave;
SELECT master_gtid_wait('0-1-7', 5);
master_gtid_wait('0-1-7', 5)
-1
SELECT @@GLOBAL.gtid_slave_pos;
@@GLOBAL.gtid_slave_pos
0-1-3
CALL mtr.add_suppression("Slave: Connection was killed");
CALL mtr.add_suppression("Slave: Commit failed due to failure of an earlier commit on which this one depends");
ROLLBACK;
SET @@global.slave_parallel_threads= 0;
SET @@global.slave_parallel_mode= conservative;
SET @@global.innodb_lock_wait_timeout= 50;
SET @@global.slave_transaction_retries= 10;
include/start_slave.inc
include/rpl_end.inc
