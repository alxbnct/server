include/master-slave.inc
[connection master]
include/rpl_connect.inc [creating slave2]
connection slave;
include/stop_slave.inc
SET @old_parallel_threads= @@GLOBAL.slave_parallel_threads;
SET GLOBAL slave_parallel_threads=3;
SET @old_parallel_mode= @@GLOBAL.slave_parallel_mode;
SET GLOBAL slave_parallel_mode=optimistic;
CHANGE MASTER TO master_use_gtid=slave_pos;
include/start_slave.inc
connection master;
ALTER TABLE mysql.gtid_slave_pos ENGINE=InnoDB;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1,0), (2,0), (3,0);
include/save_master_gtid.inc
connection slave;
include/sync_with_master_gtid.inc
include/stop_slave.inc
connection slave1;
BEGIN;
UPDATE t1 SET b=b+1 WHERE a=3;
connection slave;
include/start_slave.inc
connection master;
UPDATE t1 SET b=b+2 WHERE a=3;
INSERT INTO t1 VALUES (4, 0);
INSERT INTO t1 VALUES (5, 0);
SELECT COUNT(*) FROM t1;
COUNT(*)
5
SELECT COUNT(*) FROM t1;
COUNT(*)
105
connection slave;
connection slave2;
STOP SLAVE;
connection slave;
connection slave1;
ROLLBACK;
connection slave2;
connection slave;
include/wait_for_slave_to_stop.inc
SELECT "Ok" as `Stop position correct?`;
Stop position correct?
Ok
SELECT COUNT(*) FROM t1;
COUNT(*)
5
SET GLOBAL slave_parallel_threads= @old_parallel_threads;
SET GLOBAL slave_parallel_mode= @old_parallel_mode;
include/start_slave.inc
connection master;
DROP TABLE t1;
include/rpl_end.inc
